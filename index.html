<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gourmet Patagon v28.0</title>
    <style>
        :root { --primary: #e67e22; --dark: #2c3e50; --success: #25d366; --bg: #fdfaf6; --danger: #e74c3c; --blue: #3498db; --gold: #f1c40f; --win: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--dark); padding: 10px; margin: 0; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 480px; margin: auto; background: white; padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        .step-title { font-size: 0.9rem; color: var(--primary); text-transform: uppercase; font-weight: 800; margin: 15px 0 10px; border-bottom: 1px solid #eee; }
        
        /* Animaciones */
        .btn-add { background: #95a5a6; color: white; padding: 16px; margin-top: 10px; width: 100%; border-radius: 12px; font-weight: 800; border: none; cursor: pointer; transition: all 0.3s ease; font-size: 1rem; }
        .btn-add-active { background: var(--primary) !important; animation: glow-orange 1.5s infinite; transform: scale(1.02); }
        @keyframes glow-orange { 0% { box-shadow: 0 0 5px #e67e22; } 50% { box-shadow: 0 0 20px #e67e22; transform: scale(1.04); } 100% { box-shadow: 0 0 5px #e67e22; } }
        @keyframes shake-cart { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake { animation: shake-cart 0.4s ease-in-out; }

        .ahorro-box { background: #eafaf1; border: 2px dashed var(--win); border-radius: 15px; padding: 12px; margin: 10px 0; display: none; text-align: center; color: var(--win); font-weight: 700; font-size: 0.9rem; }
        .logistica-box { background: #fff5eb; padding: 15px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 15px; }
        .grid-combos { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .combo-card { border: 2px solid #f0f0f0; padding: 10px; border-radius: 15px; text-align: center; cursor: pointer; position: relative; display: flex; flex-direction: column; justify-content: center; min-height: 95px; }
        .combo-card input { position: absolute; opacity: 0; }
        .combo-card:has(input:checked) { border-color: var(--primary); background: #fff5eb; }
        .combo-card i { font-style: normal; font-size: 0.9rem; color: var(--primary); font-weight: 800; }
        
        #promo-box { background: #fff9db; padding: 12px; border-radius: 15px; border: 2px solid var(--gold); margin-bottom: 15px; display: none; text-align: center; animation: pulse-yellow 2s infinite; cursor: pointer; }
        @keyframes pulse-yellow { 0% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.7); } 70% { box-shadow: 0 0 0 12px rgba(241, 196, 15, 0); } 100% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); } }
        
        .check-row-vertical { display: flex; align-items: center; gap: 10px; font-weight: bold; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #eee; cursor: pointer; font-size: 0.88rem; margin-top: 4px; }
        .selector-box { background: #f9f9f9; padding: 12px; border-radius: 15px; margin-bottom: 10px; display: none; border-left: 5px solid var(--primary); }
        .total-banner { background: var(--dark); color: white; padding: 15px; border-radius: 15px; text-align: center; font-weight: bold; font-size: 1.2rem; margin: 15px 0; }
        input[type="text"], select, textarea { width: 100%; padding: 12px; margin-bottom: 8px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h2>üèîÔ∏è EL GOURMET PATAGON</h2><span>Cocina Taller - Coyhaique</span></div>

    <div class="step-title">1. Log√≠stica üöö</div>
    <div class="logistica-box" id="log-box">
        <input type="text" id="nombre" placeholder="Nombre y Apellido">
        <select id="modalidad" onchange="render()"><option value="reparto">Servicio de Reparto</option><option value="retiro">Retiro en Cocina Taller (-$500)</option></select>
        <select id="pago" onchange="render()"><option value="">Seleccione Pago...</option><option value="Transferencia">üì≤ Transferencia (-$500)</option><option value="Efectivo">üíµ Efectivo</option></select>
    </div>

    <div class="step-title">2. Arma tu Plato üß©</div>
    <div class="grid-combos">
        <label class="combo-card"><input type="radio" name="combo" value="7500" data-name="Men√∫ A" onclick="checkUI('A')"><b>Men√∫ A</b><span>Principal</span><i>$7.500</i></label>
        <label class="combo-card"><input type="radio" name="combo" value="8500" data-name="Men√∫ B" onclick="checkUI('B')"><b>Men√∫ B</b><span>Entrante+Prin.</span><i>$8.500</i></label>
        <label class="combo-card"><input type="radio" name="combo" value="3500" data-name="Sopa/Crema" onclick="checkUI('S')"><b>Sopa/Crema</b><i>$3.500</i></label>
        <label class="combo-card"><input type="radio" name="combo" value="3500" data-name="Dulce" onclick="checkUI('D')"><b>Dulce</b><i>$3.500</i></label>
    </div>

    <div id="promo-box" onclick="aplicarPromo()">
        <span>ü•ûüçØüçì</span><br><b>¬°EXPERIENCIA COMPLETA!</b><br><small>Suma tu Dulce por solo <b>+$2.000</b></small>
    </div>

    <div id="ui-principal" class="selector-box">
        <b>Plato Principal:</b>
        <select id="principal_val" onchange="toggleProt()">
            <option value="Plato del D√≠a">ü•ò Plato del D√≠a</option>
            <option value="La Gran Ensalada">ü•ó La Gran Ensalada</option>
        </select>
        <div id="ui-prot" style="display:none; margin-top:10px;">
            <b>Elija 2 Prote√≠nas:</b>
            <label class="check-row-vertical"><input type="checkbox" class="p-check" value="Duo de Lentejas"> Duo de Lentejas ü•ò</label>
            <label class="check-row-vertical"><input type="checkbox" class="p-check" value="Huevo Sancochado"> Huevo Sancochado ü•ö</label>
            <label class="check-row-vertical"><input type="checkbox" class="p-check" value="Quinoa Tricolor"> Quinoa Tricolor ü•ó</label>
            <label class="check-row-vertical"><input type="checkbox" class="p-check" value="Suprema de Ave"> Suprema de Ave üçó</label>
        </div>
    </div>

    <div class="step-title">Complementos ‚ú®</div>
    <label class="check-row-vertical"><input type="checkbox" id="bamboo" onchange="render()"> üéã Cubiertos Bamboo (+$1.000)</label>
    <label class="check-row-vertical"><input type="checkbox" id="yogurth" onchange="render()"> üçãü•£ Salsa Yogurth c√≠trico (+$1.000)</label>
    
    <div id="wrapper-extra-prot" style="opacity: 0.5; pointer-events: none;">
        <label class="check-row-vertical"><input type="checkbox" id="extra_prot" onchange="render()"> ü•© Prote√≠na Extra (+$1.000)</label>
        <div id="input-extra-prot" style="display:none; margin-top:5px;">
            <input type="text" id="cual_prot" placeholder="¬øCu√°l prote√≠na extra desea?">
        </div>
    </div>

    <button id="btn-add-main" onclick="addItem()" class="btn-add">‚ûï A√ëADIR SELECCI√ìN</button>
    
    <div id="resumen_visual" style="display:none; margin-top:20px;">
        <div id="items_cart" style="background:#fff; border:1px solid #eee; border-radius:15px; padding:10px;"></div>
        <div id="ahorro_box" class="ahorro-box"></div>
    </div>

    <div class="total-banner" id="total_final">TOTAL: $0</div>
    <button class="btn-send" onclick="send()" style="background:var(--success); color:white; padding:20px; width:100%; border-radius:15px; font-weight:bold; border:none; cursor:pointer;">ENVIAR PEDIDO ‚úÖ</button>
</div>

<script>
    let cart = []; let totalGlobal = 0; let promoAplicadaEnSesion = false;

    function checkUI(t){
        document.getElementById('ui-principal').style.display = (t==='A' || t==='B') ? 'block' : 'none';
        toggleProt();
        render();
    }

    function toggleProt(){
        const isEnsalada = document.getElementById('principal_val').value === 'La Gran Ensalada' && (document.querySelector('input[name="combo"]:checked')?.dataset.name.includes('Men√∫'));
        document.getElementById('ui-prot').style.display = isEnsalada ? 'block' : 'none';
        // Habilitar/Deshabilitar Prote√≠na Extra solo si es ensalada
        const wrapExtra = document.getElementById('wrapper-extra-prot');
        if(isEnsalada) { wrapExtra.style.opacity = "1"; wrapExtra.style.pointer_events = "auto"; wrapExtra.style.pointerEvents = "auto"; }
        else { wrapExtra.style.opacity = "0.5"; wrapExtra.style.pointerEvents = "none"; document.getElementById('extra_prot').checked = false; }
        render();
    }

    function aplicarPromo(){
        cart.push({ name: "Dulce (Promo)", price: 2000, isPromo: true });
        promoAplicadaEnSesion = true; // Bloquea el bot√≥n hasta que se a√±ada otro men√∫
        triggerCartAnim();
        render();
    }

    function triggerCartAnim() {
        const cartEl = document.getElementById('resumen_visual');
        cartEl.classList.remove('shake'); void cartEl.offsetWidth; cartEl.classList.add('shake');
    }

    function addItem(){
        const c = document.querySelector('input[name="combo"]:checked');
        const b = document.getElementById('bamboo').checked;
        const y = document.getElementById('yogurth').checked;
        const ep = document.getElementById('extra_prot').checked;
        const prot_ex = document.getElementById('cual_prot').value;

        if(c){
            const isE = document.getElementById('principal_val').value==='La Gran Ensalada' && (c.dataset.name.includes('Men√∫'));
            const pts = Array.from(document.querySelectorAll('.p-check:checked')).map(p => p.value);
            if(isE && pts.length !== 2) return alert("Por favor, elija exactamente 2 prote√≠nas.");
            if(ep && !prot_ex) return alert("Escriba qu√© prote√≠na extra desea.");
            
            cart.push({ 
                name: c.dataset.name, price: parseInt(c.value), 
                pri: (c.dataset.name.includes('Men√∫'))?document.getElementById('principal_val').value:'', 
                pts: isE ? (ep ? pts.join("/") + " + Extra: " + prot_ex : pts.join("/")) : "",
                extras: { bamboo: b, yogurth: y, extra_prot: ep, prot_text: prot_ex }
            });
            if(c.dataset.name.includes('Men√∫')) promoAplicadaEnSesion = false; // Desbloquea promo al a√±adir nuevo men√∫
            c.checked = false;
        } else if(b || y) {
            if(b) cart.push({ name: "Solo Cubiertos üéã", price: 1000, extras:{} });
            if(y) cart.push({ name: "Solo Salsa Yogurth üçãü•£", price: 1000, extras:{} });
        } else { return alert("Seleccione un plato o complemento."); }
        
        triggerCartAnim();
        document.querySelectorAll('.p-check').forEach(p => p.checked = false);
        ['bamboo','yogurth','extra_prot'].forEach(id => document.getElementById(id).checked = false);
        document.getElementById('cual_prot').value = "";
        render();
    }

    function render(){
        const itemsDiv = document.getElementById('items_cart'); itemsDiv.innerHTML = ""; let sub = 0; let ahorro = 0;
        document.getElementById('resumen_visual').style.display = cart.length > 0 ? "block" : "none";
        
        cart.forEach((it, i) => {
            let itTotal = it.price;
            if(it.extras?.bamboo) itTotal += 1000;
            if(it.extras?.yogurth) itTotal += 1000;
            if(it.extras?.extra_prot) itTotal += 1000;
            sub += itTotal;
            if(it.isPromo) ahorro += 1500;
            itemsDiv.innerHTML += `<div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:5px; border-left:4px solid var(--primary); display:flex; justify-content:space-between; align-items:center; font-size:0.85rem;">
                <div><b>${it.name}</b><br><small>${it.pri||''} ${it.pts||''}</small></div>
                <div><b>$${itTotal.toLocaleString()}</b> <span onclick="cart.splice(${i},1);render()" style="color:red; cursor:pointer; font-weight:bold; margin-left:10px;">√ó</span></div>
            </div>`;
        });

        const mod = document.getElementById('modalidad').value;
        const pago = document.getElementById('pago').value;
        if(mod === 'retiro') ahorro += 500;
        if(pago === 'Transferencia') ahorro += 500;

        const aBox = document.getElementById('ahorro_box');
        aBox.style.display = ahorro > 0 ? 'block' : 'none';
        aBox.innerHTML = `‚ú® ¬°Llevas ganando $${ahorro.toLocaleString()} en beneficios! ‚ú®`;

        // L√≥gica de visibilidad del Bot√≥n Promo
        const tieneMenuEnCarro = cart.some(it => it.name.includes("Men√∫"));
        document.getElementById('promo-box').style.display = (tieneMenuEnCarro && !promoAplicadaEnSesion) ? 'block' : 'none';

        // Brillo bot√≥n a√±adir
        const algo = document.querySelector('input[name="combo"]:checked') || document.getElementById('bamboo').checked || document.getElementById('yogurth').checked;
        document.getElementById('btn-add-main').className = algo ? 'btn-add btn-add-active' : 'btn-add';

        // Mostrar input de prote√≠na extra
        document.getElementById('input-extra-prot').style.display = document.getElementById('extra_prot').checked ? 'block' : 'none';

        totalGlobal = sub + (mod === 'retiro' ? -500 : 0) + (pago === 'Transferencia' ? -500 : 0);
        document.getElementById('total_final').innerText = "TOTAL: $" + totalGlobal.toLocaleString('es-CL');
    }

    function send(){
        if(!document.getElementById('nombre').value || cart.length === 0 || !document.getElementById('pago').value) return alert("Faltan datos.");
        let msg = `*PEDIDO PATAGON*%0Aüë§ *Cliente:* ${document.getElementById('nombre').value}%0A%0A`;
        cart.forEach(it => { msg += `‚Ä¢ *${it.name}* ${it.pri||''} ${it.pts||''}%0A`; });
        msg += `%0Aüí∞ *TOTAL: $${totalGlobal.toLocaleString()}*%0Aüí≥ *Pago:* ${document.getElementById('pago').value}`;
        window.open(`https://wa.me/56994004188?text=${msg}`);
    }
</script>
</body>
</html>
